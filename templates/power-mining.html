<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Title}} - Power & Mining</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/static/css/dashboard.css" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <script src="/static/js/theme.js"></script>
</head>
<body>
    <div class="wrapper">
        <!-- Sidebar -->
        <nav id="sidebar" class="bg-dark">
            <div class="sidebar-header p-3">
                <h4 class="text-white mb-0">
                    <i class="bi bi-speedometer2 me-2"></i>Dashboard
                </h4>
            </div>
            <ul class="nav flex-column p-3">
                <li class="nav-item">
                    <a class="nav-link" href="/">
                        <i class="bi bi-house-door me-2"></i>Overview
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/miners">
                        <i class="bi bi-cpu me-2"></i>Miners
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="/power-mining">
                        <i class="bi bi-lightning-charge me-2"></i>Power & Mining
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/environment">
                        <i class="bi bi-thermometer-half me-2"></i>Environment
                    </a>
                </li>
                {{if .ShowManage}}
                <li class="nav-item">
                    <a class="nav-link" href="/manage">
                        <i class="bi bi-sliders me-2"></i>Manage
                    </a>
                </li>
                {{end}}
                {{if .ShowManage}}
                <li class="nav-item">
                    <a class="nav-link" href="/settings">
                        <i class="bi bi-gear me-2"></i>Settings
                    </a>
                </li>
                {{end}}
            </ul>
        </nav>

        <!-- Page Content -->
        <div id="content">
            <!-- Top Navbar -->
            <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm mb-4">
                <div class="container-fluid">
                    <button type="button" id="sidebarCollapse" class="btn btn-dark">
                        <i class="bi bi-list"></i>
                    </button>
                    <span class="navbar-text ms-3">
                        Power & Mining
                    </span>
                    <div class="ms-auto">
                        <span class="badge bg-secondary">
                            <i class="bi bi-clock me-1"></i>
                            <span id="currentTime"></span>
                        </span>
                    </div>
                </div>
            </nav>

            <!-- Main Content -->
            <div class="container-fluid">
                <!-- Status and Gauges Box -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="bi bi-lightning-charge me-2"></i>Power & Mining Overview
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row align-items-center">
                            <!-- Status Indicator -->
                            <div class="col-lg-2 col-md-4 col-sm-6 mb-3 mb-lg-0">
                                <div class="status-box text-center p-3 rounded {{if .Status.Online}}status-online{{else}}status-offline{{end}}">
                                    <div class="status-indicator mb-2">
                                        <span class="status-dot {{if .Status.Online}}online{{else}}offline{{end}}"></span>
                                    </div>
                                    <div class="status-label fw-semibold">{{.Status.Label}}</div>
                                    <div class="status-value">
                                        {{if .Status.Online}}Online{{else}}Offline{{end}}
                                    </div>
                                </div>
                            </div>

                            <!-- Gauges -->
                            {{range .Gauges}}
                            <div class="col-lg-2 col-md-4 col-sm-6 mb-3 mb-lg-0">
                                <div class="gauge-box text-center p-3 rounded bg-light">
                                    <div class="gauge-label text-muted small mb-1">{{.Label}}</div>
                                    <div class="gauge-value h4 mb-0 text-primary">{{.Value}}</div>
                                    <div class="gauge-unit text-muted small">{{.Unit}}</div>
                                </div>
                            </div>
                            {{end}}
                        </div>
                    </div>
                </div>

                <!-- Charts Grid 2x2 -->
                <div class="row">
                    <!-- Power Consumption Chart -->
                    <div class="col-lg-6 mb-4">
                        <div class="card shadow-sm h-100">
                            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                <h6 class="mb-0"><i class="bi bi-plug me-2"></i>Power Consumption</h6>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                        Options
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li><a class="dropdown-item" href="#">Refresh</a></li>
                                        <li><a class="dropdown-item" href="#">Export</a></li>
                                    </ul>
                                </div>
                            </div>
                            <div class="card-body">
                                <canvas id="powerConsumptionChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Hashrate Chart -->
                    <div class="col-lg-6 mb-4">
                        <div class="card shadow-sm h-100">
                            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                <h6 class="mb-0"><i class="bi bi-graph-up-arrow me-2"></i>Hashrate</h6>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                        Options
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li><a class="dropdown-item" href="#">Refresh</a></li>
                                        <li><a class="dropdown-item" href="#">Export</a></li>
                                    </ul>
                                </div>
                            </div>
                            <div class="card-body">
                                <canvas id="hashrateChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Efficiency Chart -->
                    <div class="col-lg-6 mb-4">
                        <div class="card shadow-sm h-100">
                            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                <h6 class="mb-0"><i class="bi bi-speedometer me-2"></i>Mining Efficiency</h6>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                        Options
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li><a class="dropdown-item" href="#">Refresh</a></li>
                                        <li><a class="dropdown-item" href="#">Export</a></li>
                                    </ul>
                                </div>
                            </div>
                            <div class="card-body">
                                <canvas id="efficiencyChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Power per Miner Chart -->
                    <div class="col-lg-6 mb-4">
                        <div class="card shadow-sm h-100">
                            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                <h6 class="mb-0"><i class="bi bi-bar-chart me-2"></i>Power per Miner</h6>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                        Options
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li><a class="dropdown-item" href="#">Refresh</a></li>
                                        <li><a class="dropdown-item" href="#">Export</a></li>
                                    </ul>
                                </div>
                            </div>
                            <div class="card-body">
                                <canvas id="powerPerMinerChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Daily Energy Usage Chart -->
                <div class="row">
                    <div class="col-12 mb-4">
                        <div class="card shadow-sm">
                            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                <h6 class="mb-0"><i class="bi bi-battery-charging me-2"></i>Daily Energy Usage (Last 7 Days)</h6>
                                <small class="text-muted">Energy (kWh) = Avg Power (W) x 24h / 1000</small>
                            </div>
                            <div class="card-body">
                                <div style="height: 300px;">
                                    <canvas id="dailyEnergyChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Thermal Insulation Section -->
                <div class="row">
                    <div class="col-12 mb-4">
                        <div class="card shadow-sm">
                            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                <h6 class="mb-0"><i class="bi bi-thermometer me-2"></i>Thermal Insulation (W/K) - Lower is Better</h6>
                                <small class="text-muted">Thermal Conductance = Power / (T_inside - T_outside)</small>
                            </div>
                            <div class="card-body">
                                <div style="height: 300px;">
                                    <canvas id="thermalInsulationChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script>
        // Sidebar toggle
        document.getElementById('sidebarCollapse').addEventListener('click', function() {
            document.getElementById('sidebar').classList.toggle('active');
        });

        // Update time
        function updateTime() {
            document.getElementById('currentTime').textContent = new Date().toLocaleTimeString();
        }
        updateTime();
        setInterval(updateTime, 1000);

        const colorPalette = [
            'rgba(255, 193, 7, 0.8)',
            'rgba(13, 110, 253, 0.8)',
            'rgba(25, 135, 84, 0.8)',
            'rgba(220, 53, 69, 0.8)',
            'rgba(13, 202, 240, 0.8)',
            'rgba(111, 66, 193, 0.8)',
        ];

        function parseTs(ts) {
            return new Date(ts.endsWith('Z') ? ts : ts + 'Z');
        }

        function makeTimeSeriesChart(canvasId, yLabel) {
            return new Chart(document.getElementById(canvasId), {
                type: 'line',
                data: { datasets: [] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, title: { display: false } },
                    scales: {
                        x: { type: 'time', display: false },
                        y: { title: { display: true, text: yLabel }, grace: '10%' }
                    }
                }
            });
        }

        // Chart 1: Total Power Consumption
        const powerChart = makeTimeSeriesChart('powerConsumptionChart', 'W');

        async function loadPowerChart() {
            try {
                const resp = await fetch('/api/charts/power-total');
                const data = await resp.json();
                if (!data.hasData || !data.points) return;
                powerChart.data.datasets = [{
                    label: 'Total Power',
                    data: data.points.map(p => ({ x: parseTs(p.timestamp), y: p.value })),
                    borderColor: 'rgb(255, 193, 7)',
                    backgroundColor: 'rgba(255, 193, 7, 0.1)',
                    fill: true, tension: 0.4, pointRadius: 0, borderWidth: 2
                }];
                powerChart.update();
            } catch (e) { console.error('Failed to load power chart:', e); }
        }

        // Chart 2: Total Hashrate
        const hashrateChart = makeTimeSeriesChart('hashrateChart', 'GH/s');

        async function loadHashrateChart() {
            try {
                const resp = await fetch('/api/charts/hashrate-total');
                const data = await resp.json();
                if (!data.hasData || !data.points) return;
                hashrateChart.data.datasets = [{
                    label: 'Total Hashrate',
                    data: data.points.map(p => ({ x: parseTs(p.timestamp), y: p.value })),
                    borderColor: 'rgb(13, 110, 253)',
                    backgroundColor: 'rgba(13, 110, 253, 0.1)',
                    fill: true, tension: 0.4, pointRadius: 0, borderWidth: 2
                }];
                hashrateChart.update();
            } catch (e) { console.error('Failed to load hashrate chart:', e); }
        }

        // Chart 3: Mining Efficiency (J/TH)
        const efficiencyChart = makeTimeSeriesChart('efficiencyChart', 'J/TH');

        async function loadEfficiencyChart() {
            try {
                const [powerResp, hashrateResp] = await Promise.all([
                    fetch('/api/charts/power-total'),
                    fetch('/api/charts/hashrate-total')
                ]);
                const powerData = await powerResp.json();
                const hashrateData = await hashrateResp.json();
                if (!powerData.hasData || !hashrateData.hasData) return;

                const hashrateMap = {};
                for (const p of hashrateData.points) {
                    hashrateMap[p.timestamp] = p.value;
                }

                const points = [];
                for (const p of powerData.points) {
                    const hr = hashrateMap[p.timestamp];
                    if (hr && hr > 0) {
                        const hashrateTH = hr / 1000;
                        points.push({ x: parseTs(p.timestamp), y: Math.round(p.value / hashrateTH * 10) / 10 });
                    }
                }

                efficiencyChart.data.datasets = [{
                    label: 'Efficiency',
                    data: points,
                    borderColor: 'rgb(25, 135, 84)',
                    backgroundColor: 'rgba(25, 135, 84, 0.1)',
                    fill: true, tension: 0.4, pointRadius: 0, borderWidth: 2
                }];
                efficiencyChart.update();
            } catch (e) { console.error('Failed to load efficiency chart:', e); }
        }

        // Chart 4: Power per Miner (bar chart from latest Shelly readings)
        let powerPerMinerChart = new Chart(document.getElementById('powerPerMinerChart'), {
            type: 'bar',
            data: { labels: [], datasets: [] },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true, title: { display: true, text: 'W' } } }
            }
        });

        async function loadPowerPerMinerChart() {
            try {
                const resp = await fetch('/api/miners/status');
                const data = await resp.json();
                if (!data.hasData || !data.miners) return;

                const labels = data.miners.map(m => m.name || m.minerIp);
                const values = data.miners.map(m => m.power);
                const colors = labels.map((_, i) => colorPalette[i % colorPalette.length]);

                powerPerMinerChart.data.labels = labels;
                powerPerMinerChart.data.datasets = [{
                    label: 'Power (W)',
                    data: values,
                    backgroundColor: colors,
                    borderRadius: 4
                }];
                powerPerMinerChart.update();
            } catch (e) { console.error('Failed to load power per miner:', e); }
        }

        // Load 2x2 charts
        loadPowerChart();
        loadHashrateChart();
        loadEfficiencyChart();
        loadPowerPerMinerChart();
        setInterval(loadPowerChart, 5 * 60 * 1000);
        setInterval(loadHashrateChart, 5 * 60 * 1000);
        setInterval(loadEfficiencyChart, 5 * 60 * 1000);
        setInterval(loadPowerPerMinerChart, 60 * 1000);

        // Thermal Insulation Chart
        let thermalChart = null;

        async function loadThermalInsulationChart() {
            try {
                const response = await fetch('/api/charts/thermal-insulation');
                const data = await response.json();

                if (!data.hasData || !data.dataPoints || data.dataPoints.length === 0) {
                    document.getElementById('thermalInsulationChart').parentElement.innerHTML =
                        '<div class="text-center text-muted py-5">No thermal data available</div>';
                    return;
                }

                // Format timestamps and extract values
                const labels = data.dataPoints.map(d => {
                    const date = new Date(d.timestamp.endsWith('Z') ? d.timestamp : d.timestamp + 'Z');
                    return date.toLocaleString('en-GB', {
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                });

                const conductanceValues = data.dataPoints.map(d => d.thermalConductance.toFixed(1));
                const deltaTValues = data.dataPoints.map(d => d.deltaT.toFixed(1));

                // Calculate average for reference line
                const avgConductance = conductanceValues.reduce((a, b) => parseFloat(a) + parseFloat(b), 0) / conductanceValues.length;

                const ctx = document.getElementById('thermalInsulationChart').getContext('2d');

                if (thermalChart) {
                    thermalChart.destroy();
                }

                thermalChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Thermal Conductance (W/K)',
                                data: conductanceValues,
                                borderColor: 'rgb(220, 53, 69)',
                                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                                fill: true,
                                tension: 0.3,
                                pointRadius: 0,
                                yAxisID: 'y'
                            },
                            {
                                label: 'ΔT (°C)',
                                data: deltaTValues,
                                borderColor: 'rgb(13, 110, 253)',
                                backgroundColor: 'transparent',
                                borderDash: [5, 5],
                                tension: 0.3,
                                pointRadius: 0,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.dataset.label || '';
                                        const value = context.parsed.y;
                                        if (label.includes('Conductance')) {
                                            return `${label}: ${value} W/K`;
                                        } else {
                                            return `${label}: ${value} °C`;
                                        }
                                    }
                                }
                            },
                            annotation: {
                                annotations: {
                                    avgLine: {
                                        type: 'line',
                                        yMin: avgConductance,
                                        yMax: avgConductance,
                                        borderColor: 'rgba(220, 53, 69, 0.5)',
                                        borderWidth: 2,
                                        borderDash: [10, 5],
                                        label: {
                                            display: true,
                                            content: `Avg: ${avgConductance.toFixed(1)} W/K`,
                                            position: 'end'
                                        }
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                display: true,
                                ticks: {
                                    maxTicksLimit: 12,
                                    maxRotation: 45
                                }
                            },
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'Thermal Conductance (W/K)'
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'ΔT (°C)'
                                },
                                grid: {
                                    drawOnChartArea: false
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Failed to load thermal insulation chart:', error);
            }
        }

        // Daily Energy Usage Chart
        let dailyEnergyChart = null;

        async function loadDailyEnergyChart() {
            try {
                const response = await fetch('/api/charts/daily-energy');
                const data = await response.json();

                if (!data.hasData || !data.days || data.days.length === 0) {
                    document.getElementById('dailyEnergyChart').parentElement.innerHTML =
                        '<div class="text-center text-muted py-5">No energy data available</div>';
                    return;
                }

                const labels = data.days.map(d => {
                    const date = new Date(d.date + 'T00:00:00');
                    return date.toLocaleDateString('en-GB', { weekday: 'short', month: 'short', day: 'numeric' });
                });

                const energyValues = data.days.map(d => d.energyKwh.toFixed(1));
                const avgPowerValues = data.days.map(d => d.avgPowerW.toFixed(0));

                const ctx = document.getElementById('dailyEnergyChart').getContext('2d');

                if (dailyEnergyChart) {
                    dailyEnergyChart.destroy();
                }

                dailyEnergyChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Energy (kWh)',
                            data: energyValues,
                            backgroundColor: 'rgba(255, 193, 7, 0.8)',
                            borderColor: 'rgb(255, 193, 7)',
                            borderWidth: 1,
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const idx = context.dataIndex;
                                        const kwh = energyValues[idx];
                                        const avgW = avgPowerValues[idx];
                                        return [`Energy: ${kwh} kWh`, `Avg Power: ${avgW} W`];
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Energy (kWh)'
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Failed to load daily energy chart:', error);
            }
        }

        loadDailyEnergyChart();
        loadThermalInsulationChart();
    </script>
</body>
</html>
