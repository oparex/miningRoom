[agent]
  interval = "60s"
  omit_hostname = true

[[inputs.mqtt_consumer]]  # Shellies - JSON
  servers = ["tcp://localhost:1883"]  # Use container name if in same network
  topics = ["+/events/+"]
  topic_tag = ""
  data_format = "json_v2"
  
  [[inputs.mqtt_consumer.topic_parsing]]
    topic = "+/events/+"   # Or broader: "shellies/#"
    tags = "device_id/_/_"            # Captures the device ID part

  [[inputs.mqtt_consumer.json_v2]]
    measurement_name = "shellies"
    timestamp_path = "params.ts"
    timestamp_format = "unix"
    timestamp_timezone = "UTC"
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "params.switch:0.apower"
      rename = "power"
      type = "float"
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "params.switch:0.current"
      rename = "current"
      type = "float"
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "params.switch:0.freq"
      rename = "frew"
      type = "float"
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "params.switch:0.pf"
      rename = "pf"
      type = "float"
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "params.switch:0.voltage"
      rename = "voltage"
      type = "float"

[[inputs.mqtt_consumer]]
  servers = ["tcp://localhost:1883"]
  topics = ["sensors/mining/bme280"]
  data_format = "json"
  json_string_fields = ["device_id","location"]
  tag_keys = ["device_id","location"]
  tagexclude = ["topic"]
  name_override = "bme280_readings"

[[inputs.http]]
  urls = ["http://10.0.0.71/kaonsu/v1/hashboards", "http://10.0.0.72/kaonsu/v1/hashboards", "http://10.0.0.73/kaonsu/v1/hashboards", "http://10.0.0.74/kaonsu/v1/hashboards", "http://10.0.0.75/kaonsu/v1/hashboards"]
  data_format = "json"                              
  name_override = "hashboards"
  tagexclude = ["host"]  
  fielddrop = ["asic_num", "asic_num_ideal", "temperature_sensors_0_value", "temperature_sensors_1_value", "temperature_sensors_1_index", "temperature_sensors_0_index"]                           

  json_query = "hashboards"

  tag_keys = ["serial_number", "index"]

  [[processors.regex]]
    [[processors.regex.tags]]
      key = "url"
      pattern = "^https?://([^:/]+)(?::\\d+)?(/.*)?$"
      replacement = "$1"
      result_key = "miner_ip"
    [[processors.regex.tags]]
      key = "url"
      pattern = ".*"
      replacement = ""

  [[processors.rename]]
  [[processors.rename.replace]]
    tag = "index"
    dest = "idx"

[[inputs.http]]
  urls = ["http://10.0.0.71/kaonsu/v1/pools", "http://10.0.0.72/kaonsu/v1/pools", "http://10.0.0.73/kaonsu/v1/pools", "http://10.0.0.74/kaonsu/v1/pools", "http://10.0.0.75/kaonsu/v1/pools"]
  data_format = "json_v2"

  [[inputs.http.json_v2]]
    # The measurement name in InfluxDB
    measurement_name = "pools"

    [[inputs.http.json_v2.object]]
      path = "@this"
      tags = ["index", "url", "user", "status"]
      disable_prepend_keys = true

      [inputs.http.json_v2.object.renames]
        url = "pool_url"

  [[processors.regex]]
    [[processors.regex.tags]]
      key = "url"
      pattern = "^https?://([^:/]+)(?::\\d+)?(/.*)?$"
      replacement = "$1"
      result_key = "miner_ip"
    [[processors.regex.tags]]
      key = "url"
      pattern = ".*"
      replacement = ""

    
[[outputs.influxdb_v2]]  # QuestDB ILP over HTTP (port 9000)
  urls = ["http://localhost:9000"]  # Container name if networked
  content_encoding = "identity"

# NiceHash API - payouts, rig status, and account balance
[[inputs.exec]]
  commands = ["python3 /path/to/miningRoom/nicehash/nicehash_telegraf.py"]
  timeout = "30s"
  interval = "5m"
  data_format = "influx"
  # Output measurements:
  #   nicehash_payouts  - payout history (amount, fee, currency)
  #   nicehash_rigs     - per-rig status (unpaid, profitability, speed)
  #   nicehash_account  - total unpaid, total profitability
  #   nicehash_balance  - account balance per currency

